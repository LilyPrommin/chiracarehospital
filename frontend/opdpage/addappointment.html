<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>Add Appointment</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="../../css/topbar.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/logo.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/button.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/form.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/popup.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="background-color:#edeff1;">

    <!-- Sidebar will be loaded here -->
    <div id="sidebar-container"></div>

    <!-- Topbar will be loaded here -->
    <div id="topbar-container"></div>

    <div class="form-section" id="updateForm">
        <h2>เพิ่มนัดการรักษา</h2>
        <form id="appointmentForm">
            <label for="name">ชื่อ – นามสกุล</label>
            <input type="text" id="name" placeholder="กรอกชื่อผู้ป่วย" required>

            <label for="disease">โรคของผู้ป่วยที่รักษา</label>
            <input type="text" id="disease" placeholder="กรอกโรคของผู้ป่วย" required>

            <label for="symptoms">อาการทั่วไป</label>
            <input type="text" id="symptoms" placeholder="กรุณากรอกอาการทั่วไป" required>

            <label for="treatment-plan">ประเด็นการรักษา</label>
            <input type="text" id="treatment-plan" placeholder="กรุณากรอกประเด็นการรักษา" required>

            <label for="start-date">วันที่เข้ารับการรักษา</label>
            <input type="date" id="start-date" required>

            <label for="next-visit-date">วันที่นัดครั้งถัดไป</label>
            <input type="date" id="next-visit-date" required>

            <label for="notes">หมายเหตุ</label>
            <input type="text" id="notes" placeholder="กรุณากรอกหมายเหตุ">

            <!-- Submit Button -->
            <div class="button-group">
                <button type="submit" onclick="confirmSubmission()">บันทึก</button>
                <button type="back" id="back">ย้อนกลับ</button>
            </div>
        </form>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
            <h3>คุณแน่ใจหรือไม่ว่าจะส่งแบบฟอร์มนี้?</h3>
            <p>กรุณาตรวจสอบข้อมูลเพื่อความถูกต้องก่อนส่ง</p>
            <div class="button-popup">
                <button type="Yes" onclick="submitForm()">ใช่</button>
                <button type="No" onclick="closePopup()">ไม่</button>
            </div>
        </div>
    </div>

    <script>
        // ดึงข้อมูลจาก URL
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name');
        const disease = urlParams.get('disease');

        // แสดงในฟอร์ม
        document.getElementById('name').value = decodeURIComponent(name);
        document.getElementById('disease').value = decodeURIComponent(disease);

        // การจัดการเมื่อฟอร์มถูกส่ง
        document.getElementById('appointmentForm').onsubmit = function (e) {
            e.preventDefault(); // หยุดการรีเฟรชหน้า
            // ดึงค่าจากฟอร์ม
            const symptoms = document.getElementById('symptoms').value;
            const treatmentPlan = document.getElementById('treatment-plan').value;
            const startDate = document.getElementById('start-date').value;
            const nextVisitDate = document.getElementById('next-visit-date').value;
            const notes = document.getElementById('notes').value;

            // ทำการส่งข้อมูลไปยังฐานข้อมูล
            const data = {
                name: name,
                disease: disease,
                symptoms: symptoms,
                treatmentPlan: treatmentPlan,
                startDate: startDate,
                nextVisitDate: nextVisitDate,
                notes: notes
            };

            fetch('http://localhost/chiracarehospital/backend/sql/opd/update_patient_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    console.log(result);
                    // อาจจะมีการแสดงข้อความสำเร็จหรือเปลี่ยนหน้าไปยังที่อื่น
                })
                .catch(error => console.error("Error updating patient data:", error));
        };
    </script>

    <script>
        // Load sidebar
        fetch('sidebar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
                loadSidebarScript(); // Initialize sidebar toggle after loading
            });

        // Load topbar and set the page title
        fetch('topbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('topbar-container').innerHTML = data;
                document.getElementById('page-title').textContent = 'การแจ้งเตือน'; // Set page title for the main page
            });

        function loadSidebarScript() {
            let sidebar = document.querySelector(".sidebar");
            let closeBtn = document.querySelector("#btn");

            closeBtn.addEventListener("click", () => {
                sidebar.classList.toggle("open");
                menuBtnChange();
            });

            function menuBtnChange() {
                if (sidebar.classList.contains("open")) {
                    closeBtn.classList.replace("bx-menu", "bx-menu-alt-right");
                } else {
                    closeBtn.classList.replace("bx-menu-alt-right", "bx-menu");
                }
            }
            document.getElementById('back').addEventListener('click', function () {
                window.location.href = 'main.html';
            });
        }
    </script>

    <script>
        // Show the confirmation pop-up
        function confirmSubmission() {
            document.getElementById("popup").style.display = "flex";
        }

        // Close the pop-up
        function closePopup() {
            document.getElementById("popup").style.display = "none";
        }

        // Submit the form and go back to the previous page
        function submitForm() {
            // You can add form validation logic here if needed
            closePopup();

            // Simulate form submission or redirect to the previous page
            alert('Form submitted successfully!');
            window.history.back();  // Go back to the previous page
        }

    </script>

</body>

</html>